# 开发问题

## uniapp+htmal2canvas 实现海报分享的功能。

### 问题 1：html2canvas 在 uniapp 小程序环境下不能使用。

- 原因：html2canvas 为网页库，在 uniapp 的逻辑层环境可能运行会缺少方法导致报错。

- 解决方案：可以通过 uniapp 的 renderjs 的让其运行在视图层。[renderjs 相关文档](https://uniapp.dcloud.net.cn/tutorial/renderjs.html#renderjs)

- 相关代码：

```javascript{2,7-9,18-36}
  <template>
    <view @click="renderScript.emitData"></view> //只能在此调用，逻辑层不能调用
  </template>
  <script>
  	export default {
  		methods: {
  			async receiveRenderData(val) {
                console.log(val) // 接受传过来参数
  			},
  		},
  	}
  </script>
  <script module="renderScript" lang="renderjs">
  	import html2canvas from 'html2canvas';
  	export default {
  		methods: {
  			// 发送数据到逻辑层
  			emitData(e, ownerVm) {
  				let targetDom = document.getElementsByClassName('lb-big-box')[0]
  				targetDom.style.width = targetDom.scrollWidth + 'px'
  				targetDom.style.height = targetDom.scrollHeight + 'px'
  				html2canvas(targetDom, {
  					useCORS: true,
  					width: targetDom.scrollWidth, //dom 原始宽度
  					height: targetDom.scrollHeight,
  					logging: true,
  					scale: 5
  				}).then((canvas) => {
  					targetDom.style.width = targetDomWidth + 'px'
  					targetDom.style.height = targetDomHeight + 'px'
  					ownerVm.callMethod('receiveRenderData', {
  						url: canvas.toDataURL('image/png'),
  						width: targetDom.scrollWidth, //dom 原始宽度
  						height: targetDom.scrollHeight,
  					})
  				});
  			},
  		}
  	};
  </script>
```

### 问题 2：生成 html2canvas 的图片高度不全的问题。

- 原因：生成的元素父级及其不能为滚动区域。

- 解决方案：将其高度固定为 scrollHeight 及其父级能不能出现滚动，打印后将其高度还原。

```javascript {3-4,12-13}
emitData(e, ownerVm) {
  let targetDom = document.getElementsByClassName('lb-big-box')[0]
  targetDom.style.width = targetDom.scrollWidth + 'px'
  targetDom.style.height = targetDom.scrollHeight + 'px'
  html2canvas(targetDom, {
  	useCORS: true,
  	width: targetDom.scrollWidth, //dom 原始宽度
  	height: targetDom.scrollHeight,
  	logging: true,
  	scale: 5
  }).then((canvas) => {
  	targetDom.style.width = targetDomWidth + 'px'
  	targetDom.style.height = targetDomHeight + 'px'
  	ownerVm.callMethod('receiveRenderData', {
  		url: canvas.toDataURL('image/png'),
  		width: targetDom.scrollWidth, //dom 原始宽度
  		height: targetDom.scrollHeight,
  	})
});
```

总结：遇到问题首先要多实践，必要时可以和大家一起多讨论，个人思维太狭隘，容易陷入思维盲区。

### 问题 3：uniapp 小程序环境不能将 base64 转为图片文件。

- 原因：uniapp 小程序的环境中没有 blob，app 的 plus 库不能用

- 解决方案：暂定服务端接口解析 base64 并上传至 oss 服务器，返回图片文件 url。



<script setup>
import "gitalk/dist/gitalk.css";
import Gitalk from "gitalk";
import { onMounted } from 'vue';
onMounted(() => {
  if(typeof window !==undefined){
    var s_div = document.createElement('div');   // 创建节点
    s_div.setAttribute("id", "gitalk-page-container");   // 设置id
    document.querySelector('.content-container').appendChild(s_div);   // querySelector的节点可自己根据自己想加载的地方设置
    var gitalk = new Gitalk({  //（上面的都不要改，从这里开始填写信息）
        clientID: 'Ov23linRVtNBqf4PKfUx',          // 填写之前创建OAuth App保存的clientID
        clientSecret: '5623d8f91bf85ed23a13e119b4d810e36d2cd989',  // 填写之前创建OAuth App保存的clientSecret
        repo: 'lbNotes',          // 填写你用于存放评论的仓库名，注意需要仓库打开了issues功能（一般默认打开）
        owner: 'taogelaodao',   // 填写你的github用户名
        admin: ['taogelaodao'], // 填写github管理者列表
        id: decodeURI(location.pathname),      // 不变，Ensure uniqueness and length less than 50
        distractionFreeMode: false  // 不变，Facebook-like distraction free mode
    })
    gitalk.render('gitalk-page-container')
  }
})
</script>
<div id="gitalk"></div>